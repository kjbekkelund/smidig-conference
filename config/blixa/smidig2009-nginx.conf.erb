upstream <%= environment %>_smidig2009 {
  <% for port_instance in port..(port+3) %>
      server 127.0.0.1:<%= port_instance %>;
  <% end %>
}

server {
    listen       80;
    server_name  <%= hostname %> www.<%= hostname %>;

    root         <%= application_path %>;
    index        index.html index.htm;

    access_log   <%= application_path %>/log/nginx_access.log  combined;
    error_log    <%= application_path %>/log/nginx_error.log;

    # Capistrano maintenance state
    if (-f $document_root/maintenance.html) {
      rewrite ^(.*)$ /maintenance.html last;
      break;
    }

    location / {
        if (-f $request_filename) {
          break;
        }

        if (-f $request_filename/index.html) {
            rewrite (.*) $1/index.html break;
        }

        if (-f $request_filename.html) {
            # Rails cached requests
            rewrite (.*) $1.html break;
        }

        proxy_pass http://<%= environment %>_smidig2009;
        include /opt/nginx/conf/proxy.conf;
        break;
    }

     #error_page  404              /404.html;
     error_page   500 502 503 504  /50x.html;
     location = /50x.html {
         root   html;
     }
}

